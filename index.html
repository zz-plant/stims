<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="description" content="Audio-reactive visual toys for sensory stimulation and creative play. Open-source, no accounts required." />
    <meta name="robots" content="index,follow" />
    <meta name="theme-color" content="#0b0f1a" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <link rel="canonical" href="https://no.toil.fyi/" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg" />
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32.png" />
    <link rel="apple-touch-icon" href="/icons/icon-192.png" />
    <title>Stim Webtoys Library</title>
    <meta property="og:title" content="Stim Webtoys Library" />
    <meta property="og:description" content="Audio-reactive visual toys for sensory stimulation and creative play. Open-source, no accounts required." />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://no.toil.fyi/" />
    <meta property="og:image" content="https://no.toil.fyi/icons/icon-512.png" />
    <meta property="og:image:alt" content="Stim Webtoys Library icon" />
    <meta property="og:site_name" content="Stim Webtoys Library" />
    <meta property="og:locale" content="en_US" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Stim Webtoys Library" />
    <meta name="twitter:description" content="Audio-reactive visual toys for sensory stimulation and creative play. Open-source, no accounts required." />
    <meta name="twitter:image" content="https://no.toil.fyi/icons/icon-512.png" />
    <meta name="twitter:image:alt" content="Stim Webtoys Library icon" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"
    />
    <link rel="preload" href="assets/css/base.css" as="style" />
    <link rel="preload" href="assets/css/index.css" as="style" />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="assets/css/base.css" />
    <link rel="stylesheet" href="assets/css/index.css" />
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@graph": [
          {
            "@type": "Organization",
            "@id": "https://no.toil.fyi/#organization",
            "name": "Stim Lab",
            "url": "https://no.toil.fyi/",
            "sameAs": ["https://github.com/zz-plant/stims"]
          },
          {
            "@type": "WebSite",
            "@id": "https://no.toil.fyi/#website",
            "url": "https://no.toil.fyi/",
            "name": "Stim Webtoys Library",
            "publisher": { "@id": "https://no.toil.fyi/#organization" },
            "inLanguage": "en",
            "description": "Audio-reactive visual toys for sensory stimulation and creative play.",
            "image": {
              "@type": "ImageObject",
              "url": "https://no.toil.fyi/icons/icon-512.png",
              "width": 512,
              "height": 512
            }
          },
          {
            "@type": ["WebPage", "CollectionPage"],
            "@id": "https://no.toil.fyi/#webpage",
            "url": "https://no.toil.fyi/",
            "name": "Stim Webtoys Library",
            "headline": "Feel-first visuals that breathe with your audio.",
            "description": "Explore audio, color, and motion without setup. Every stim opens fast, responds to mic and touch, and comes with sensible defaults that keep you in flow.",
            "isPartOf": { "@id": "https://no.toil.fyi/#website" },
            "publisher": { "@id": "https://no.toil.fyi/#organization" },
            "inLanguage": "en",
            "primaryImageOfPage": {
              "@type": "ImageObject",
              "url": "https://no.toil.fyi/icons/icon-512.png",
              "width": 512,
              "height": 512
            }
          }
        ]
      }
    </script>
  </head>
  <body data-page="library">
    <a class="skip-link" href="#toy-list">Skip to library</a>
    <div class="content">
      <header class="shell-header">
        <div data-top-nav-container></div>
        <div class="shell-panels">
          <div class="shell-panel" data-audio-controls hidden></div>
          <div class="shell-panel" data-settings-panel hidden></div>
        </div>
      </header>

      <section class="intro" id="intro">
        <div class="section-heading">
          <p class="eyebrow">Audio-reactive visuals ‚Ä¢ Instant play</p>
          <h1>Stim library</h1>
          <p class="section-description">Start a visual toy tuned for sound, touch, and focus.</p>
          <ul class="intro-pills" aria-label="Quick highlights">
            <li class="intro-pill">‚ú® Featured: Halo Flow</li>
            <li class="intro-pill">üéß Mic not required</li>
            <li class="intro-pill">üîä Built-in audio</li>
            <li class="intro-pill">üñêÔ∏è Touch-friendly</li>
            <li class="intro-pill">üîÅ Auto-switch flow mode</li>
          </ul>
        </div>
        <div class="cta-row hero-cta-row">
          <a
            href="toy.html?toy=holy"
            class="cta-button primary"
            data-quickstart-slug="holy"
          >
            Open Halo Flow
          </a>
          <a
            href="toy.html?toy=spiral-burst"
            class="cta-button cta-button--muted"
            data-quickstart-mode="random"
            data-quickstart-pool="featured"
            data-quickstart-audio="demo"
            data-quickstart-flow="true"
          >
            Start flow mode
          </a>
          <a
            href="toy.html?toy=spiral-burst"
            class="cta-button cta-button--accent"
            data-quickstart-mode="random"
            data-quickstart-pool="featured"
            data-quickstart-audio="demo"
          >
            Surprise me
          </a>
          <a href="#toy-list" class="cta-button ghost">Browse all stims</a>
        </div>
        <div class="intro-grid" aria-label="Fast facts">
          <div class="intro-card">
            <p class="intro-card__title">Choose a vibe</p>
            <p class="intro-card__body">Pick calm, energetic, or immersive to jump in.</p>
          </div>
          <div class="intro-card">
            <p class="intro-card__title">Start in seconds</p>
            <p class="intro-card__body">No setup‚Äîopen a toy and react to audio.</p>
          </div>
          <div class="intro-card">
            <p class="intro-card__title">Built for touch</p>
            <p class="intro-card__body">Works on phone, tablet, and desktop.</p>
          </div>
        </div>
        <div class="hero-readiness" data-hero-readiness-summary>
          <p class="hero-readiness__text" data-hero-readiness-text aria-live="polite">
            Checking device‚Ä¶
          </p>
          <button
            type="button"
            class="cta-button ghost hero-readiness__action"
            data-open-preflight
          >
            Tune device
          </button>
        </div>
      </section>

      <section class="quick-starts" id="quick-starts">
        <div class="section-heading">
          <p class="eyebrow">Quick start</p>
          <h2>Start playing fast</h2>
          <p class="section-description">
            Pick a quick start without scrolling.
          </p>
        </div>
        <div class="quick-start-grid">
          <article class="quick-card">
            <p class="quick-card__eyebrow">Featured</p>
            <h3>Halo Flow</h3>
            <p>Soft nebula arcs that react to audio and touch.</p>
            <div class="quick-card__actions">
              <a
                href="toy.html?toy=holy"
                class="cta-button primary"
                data-quickstart-slug="holy"
              >
                Open Halo Flow
              </a>
              <a href="#toy-list" class="text-link">See similar toys</a>
            </div>
          </article>
          <article class="quick-card">
            <p class="quick-card__eyebrow">Flow mode</p>
            <h3>Auto-switch playlist</h3>
            <p>Let the library cycle through featured toys.</p>
            <div class="quick-card__actions">
              <a
                href="toy.html?toy=spiral-burst"
                class="cta-button cta-button--muted"
                data-quickstart-mode="random"
                data-quickstart-pool="featured"
                data-quickstart-audio="demo"
                data-quickstart-flow="true"
              >
                Start flow mode
              </a>
              <a href="#library" class="text-link">Choose a pool</a>
            </div>
          </article>
          <article class="quick-card">
            <p class="quick-card__eyebrow">Surprise</p>
            <h3>Random featured toy</h3>
            <p>Jump into a featured toy you might not have seen.</p>
            <div class="quick-card__actions">
              <a
                href="toy.html?toy=spiral-burst"
                class="cta-button cta-button--accent"
                data-quickstart-mode="random"
                data-quickstart-pool="featured"
                data-quickstart-audio="demo"
              >
                Surprise me
              </a>
              <a href="#toy-list" class="text-link">Browse all</a>
            </div>
          </article>
        </div>
      </section>

      <section class="library" id="library">
        <div class="section-heading">
          <p class="eyebrow">Library</p>
          <h2>Browse all stims</h2>
          <p class="section-description">
            Tap a card to launch or open details.
          </p>
          <search class="library-search">
            <div class="search-heading">
              <h3>Find a stim</h3>
              <p>Search by name, mood, or capability.</p>
            </div>
            <div class="search-row">
              <label class="sr-only" for="toy-search">Search the library</label>
              <form class="search-field" role="search" data-search-form>
                <span class="search-field__icon" aria-hidden="true">‚åï</span>
                <input
                  id="toy-search"
                  type="search"
                  name="toy-search"
                  placeholder="Search stims by name, tag, or capability‚Ä¶"
                  autocomplete="off"
                  aria-describedby="toy-search-hint"
                  inputmode="search"
                  list="toy-search-suggestions"
                />
                <button
                  type="button"
                  class="search-clear"
                  data-search-clear
                  aria-label="Clear search"
                >
                  Clear
                </button>
                <span id="toy-search-hint" class="search-field__hint">
                  Enter a name, tag, or capability
                </span>
                <datalist id="toy-search-suggestions"></datalist>
              </form>
              <div class="search-meta">
                <p
                  class="search-meta__results"
                  data-search-results
                  role="status"
                  aria-live="polite"
                >
                  Loading library‚Ä¶
                </p>
              </div>
            </div>
            <div class="active-filters" data-active-filters hidden>
              <span class="active-filters__label">Active</span>
              <div class="active-filters__chips" data-active-filters-chips></div>
              <button
                type="button"
                class="active-filters__clear"
                data-active-filters-clear
              >
                Clear all
              </button>
            </div>
            <div class="filter-row" role="group" aria-label="Curated filters">
              <div class="chip-row" data-chip-row>
                <button
                  type="button"
                  class="filter-chip"
                  data-filter-chip
                  data-filter-type="mood"
                  data-filter-value="calm"
                >
                  Calm
                </button>
                <button
                  type="button"
                  class="filter-chip"
                  data-filter-chip
                  data-filter-type="mood"
                  data-filter-value="energetic"
                >
                  Energetic
                </button>
                <button
                  type="button"
                  class="filter-chip"
                  data-filter-chip
                  data-filter-type="capability"
                  data-filter-value="microphone"
                >
                  Microphone
                </button>
                <button
                  type="button"
                  class="filter-chip"
                  data-filter-chip
                  data-filter-type="capability"
                  data-filter-value="motion"
                >
                  Motion
                </button>
                <button
                  type="button"
                  class="filter-chip"
                  data-filter-chip
                  data-filter-type="capability"
                  data-filter-value="demoAudio"
                >
                  Demo audio
                </button>
                <button
                  type="button"
                  class="filter-chip"
                  data-filter-chip
                  data-filter-type="feature"
                  data-filter-value="webgpu"
                >
                  WebGPU
                </button>
              </div>
              <div class="filter-actions">
                <button type="button" class="filter-reset" data-filter-reset>
                  Clear filters
                </button>
                <label class="sort-control">
                  <span>Sort</span>
                  <select data-sort-control>
                    <option value="featured">Featured</option>
                    <option value="newest">Newest</option>
                    <option value="immersive">Most immersive</option>
                    <option value="az">A ‚Üí Z</option>
                  </select>
                </label>
              </div>
            </div>
          </search>
        </div>
        <main id="toy-list" class="webtoy-container"></main>
      </section>

      <section class="system-check" id="system-check">
        <div class="section-heading">
          <p class="eyebrow">System check</p>
          <h2>Check your device</h2>
          <p class="section-description">Live status while we scan.</p>
          <p
            class="section-description details-panel"
            data-details-panel
            id="system-check-details"
          >
            Graphics, mic, motion, comfort.
          </p>
          <button
            type="button"
            class="text-link details-toggle"
            data-details-toggle
            aria-expanded="false"
            aria-controls="system-check-details"
          >
            <span data-details-label="open">Details</span>
            <span data-details-label="close">Hide details</span>
          </button>
        </div>
        <ul class="system-legend" aria-label="System signals">
          <li class="system-legend__item">üñ•Ô∏è Graphics</li>
          <li class="system-legend__item">üéôÔ∏è Mic</li>
          <li class="system-legend__item">üß≠ Motion</li>
          <li class="system-legend__item">ü´ß Comfort</li>
        </ul>
        <div class="system-grid">
          <div class="readiness-panel" data-readiness-panel>
            <div class="readiness-header">
              <h3 class="readiness-title">Live readiness</h3>
              <p class="readiness-subtitle" data-details-panel>
                We‚Äôll keep these signals updated so you know what‚Äôs available.
              </p>
            </div>
            <ul class="readiness-list">
              <li class="readiness-item">
                <div class="readiness-label">
                  <span
                    class="readiness-dot"
                    data-status-dot="render"
                    aria-hidden="true"
                  ></span>
                  <span class="readiness-name">Graphics acceleration</span>
                </div>
                <p class="readiness-note" data-status-note="render">
                  Checking graphics‚Ä¶
                </p>
              </li>
              <li class="readiness-item">
                <div class="readiness-label">
                  <span
                    class="readiness-dot"
                    data-status-dot="mic"
                    aria-hidden="true"
                  ></span>
                  <span class="readiness-name">Microphone</span>
                </div>
                <p class="readiness-note" data-status-note="mic">
                  Checking mic‚Ä¶
                </p>
              </li>
              <li class="readiness-item">
                <div class="readiness-label">
                  <span
                    class="readiness-dot"
                    data-status-dot="motion"
                    aria-hidden="true"
                  ></span>
                  <span class="readiness-name">Motion input</span>
                </div>
                <p class="readiness-note" data-status-note="motion">
                  Checking motion‚Ä¶
                </p>
              </li>
              <li class="readiness-item">
                <div class="readiness-label">
                  <span
                    class="readiness-dot"
                    data-status-dot="reduced"
                    aria-hidden="true"
                  ></span>
                  <span class="readiness-name">Motion comfort</span>
                </div>
                <p class="readiness-note" data-status-note="reduced">
                  Reading comfort‚Ä¶
                </p>
              </li>
            </ul>
          </div>
          <div class="system-controls" data-system-controls></div>
        </div>
        <div class="cta-row system-actions">
          <button type="button" class="cta-button primary" data-open-preflight>
            Open system check
          </button>
          <a href="#toy-list" class="text-link">Skip to library</a>
        </div>
      </section>

      <footer id="site-footer">
        <div class="footer-actions">
          <p>
            Curious about how these work?
            <a
              href="https://github.com/zz-plant/stims"
              target="_blank"
              rel="noopener noreferrer"
              class="text-link"
            >
              Check out our open-source project.
            </a>
          </p>
          <p class="footer-nav">
            <a href="#intro" class="text-link">Intro</a>
            <span aria-hidden="true">¬∑</span>
            <a href="#quick-starts" class="text-link">Quick start</a>
            <span aria-hidden="true">¬∑</span>
            <a href="#system-check" class="text-link">System check</a>
            <span aria-hidden="true">¬∑</span>
            <a href="#library" class="text-link">Library</a>
          </p>
          <div class="cta-row footer-cta-row">
            <a
              href="https://github.com/zz-plant/stims/issues/new/choose"
              target="_blank"
              rel="noopener noreferrer"
              class="cta-button ghost"
              >Report an issue</a
            >
            <a
              href="https://github.com/zz-plant/stims/blob/main/CONTRIBUTING.md"
              target="_blank"
              rel="noopener noreferrer"
              class="cta-button ghost"
              >Contribute</a
            >
          </div>
          <p class="cta-helper footer-helper">
            Open-source and building in public.
          </p>
        </div>
      </footer>
    </div>

    <script>
      window.addEventListener('DOMContentLoaded', () => {
        const list = document.getElementById('toy-list');
        if (!list || list.childElementCount > 0) return;

        const search = document.getElementById('toy-search');
        const searchForm = document.querySelector('[data-search-form]');
        const searchSuggestions = document.getElementById(
          'toy-search-suggestions'
        );
        const searchResults = document.querySelector('[data-search-results]');
        const clearSearchButton = document.querySelector('[data-search-clear]');
        const resetFiltersButton = document.querySelector('[data-filter-reset]');
        const activeFiltersSummary = document.querySelector(
          '[data-active-filters]'
        );
        const activeFiltersChips = document.querySelector(
          '[data-active-filters-chips]'
        );
        const activeFiltersClear = document.querySelector(
          '[data-active-filters-clear]'
        );
        const STORAGE_KEY = 'stims-library-state';
        const QUERY_PARAM = 'q';
        const FILTER_PARAM = 'filters';
        const SORT_PARAM = 'sort';
        let cachedQuery = '';
        let sortBy = 'featured';
        const originalOrder = new Map();
        const activeFilters = new Set();
        let lastCommittedQuery = '';
        let pendingRender;

        const shouldDeferToEnhanced = () =>
          document.body.dataset.libraryEnhanced === 'true';

        const getHaystack = (toy) => {
          const capabilityTerms = Object.entries(toy.capabilities || {})
            .filter(([, enabled]) => !!enabled)
            .map(([key]) => key.toLowerCase());

          return [
            toy.title,
            toy.slug,
            toy.description,
            ...(toy.tags ?? []),
            ...(toy.moods ?? []),
            ...capabilityTerms,
            toy.requiresWebGPU ? 'webgpu' : '',
          ]
            .filter(Boolean)
            .join(' ')
            .toLowerCase();
        };

        const matchesFilters = (toy) => {
          if (activeFilters.size === 0) return true;
          return Array.from(activeFilters).every((token) => {
            const [type, value] = token.split(':');
            if (!type || !value) return true;
            if (type === 'mood') {
              return (toy.moods ?? []).some(
                (mood) => mood.toLowerCase() === value
              );
            }
            if (type === 'capability') {
              return Boolean(
                toy.capabilities?.[normalizeCapabilityToken(value)]
              );
            }
            if (type === 'feature') {
              return value === 'webgpu' ? Boolean(toy.requiresWebGPU) : true;
            }
            return true;
          });
        };

        const capabilityScore = (toy) =>
          (toy.requiresWebGPU ? 2 : 0) +
          Number(toy.capabilities?.microphone) +
          Number(toy.capabilities?.motion) +
          Number(toy.capabilities?.demoAudio);

        const getOriginalIndex = (toy) => originalOrder.get(toy.slug) ?? 0;
        const getFeaturedRank = (toy) =>
          Number.isFinite(toy.featuredRank)
            ? toy.featuredRank
            : Number.POSITIVE_INFINITY;

        const sortList = (list) => {
          const sorted = [...list];
          switch (sortBy) {
            case 'newest':
              return sorted.sort(
                (a, b) => getOriginalIndex(b) - getOriginalIndex(a)
              );
            case 'az':
              return sorted.sort((a, b) => a.title.localeCompare(b.title));
            case 'immersive':
              return sorted.sort(
                (a, b) =>
                  capabilityScore(b) - capabilityScore(a) ||
                  getOriginalIndex(a) - getOriginalIndex(b)
              );
            default:
              return sorted.sort(
                (a, b) =>
                  getFeaturedRank(a) - getFeaturedRank(b) ||
                  getOriginalIndex(a) - getOriginalIndex(b)
              );
          }
        };
        let allToys = [];

        const getSortLabel = () => {
          const sortControl = document.querySelector('[data-sort-control]');
          if (sortControl && sortControl.tagName === 'SELECT') {
            const selected = sortControl.selectedOptions?.[0];
            const label = selected?.textContent?.trim();
            if (label) return label;
          }
          const sortLabels = {
            featured: 'Featured',
            newest: 'Newest',
            immersive: 'Most immersive',
            az: 'A ‚Üí Z',
          };
          return sortLabels[sortBy] ?? sortBy;
        };

        const getActiveFilterLabels = () =>
          Array.from(
            document.querySelectorAll('[data-filter-chip].is-active')
          ).flatMap((chip) => {
            const label = chip.textContent?.trim();
            return label ? [label] : [];
          });

        const normalizeCapabilityToken = (value) => {
          const normalized = value.toLowerCase();
          if (normalized === 'demoaudio' || normalized === 'demo-audio') {
            return 'demoAudio';
          }
          return normalized;
        };

        const formatTokenLabel = (token) => {
          const [type, value = ''] = token.split(':');
          if (!type) return token;
          const normalizedValue = value.toLowerCase();
          const chipMatch = Array.from(
            document.querySelectorAll('[data-filter-chip]')
          ).find((chip) => {
            const chipType = chip.getAttribute('data-filter-type');
            const chipValue = chip.getAttribute('data-filter-value');
            return (
              chipType === type &&
              chipValue?.toLowerCase() === normalizedValue
            );
          });
          const chipLabel = chipMatch?.textContent?.trim();
          if (chipLabel) return chipLabel;
          const fallbackLabel = normalizedValue.replace(/[-_]/g, ' ');
          return fallbackLabel
            ? `${fallbackLabel[0].toUpperCase()}${fallbackLabel.slice(1)}`
            : token;
        };

        const updateActiveFiltersSummary = (query = cachedQuery) => {
          if (
            !(activeFiltersSummary instanceof HTMLElement) ||
            !(activeFiltersChips instanceof HTMLElement)
          ) {
            return;
          }
          const trimmedQuery = query.trim();
          const tokens = Array.from(activeFilters);
          const hasTokens = Boolean(trimmedQuery) || tokens.length > 0;
          activeFiltersSummary.hidden = !hasTokens;
          activeFiltersSummary.setAttribute('aria-hidden', String(!hasTokens));
          activeFiltersChips.innerHTML = '';

          const appendChip = ({ label, onClick, ariaLabel }) => {
            const chip = document.createElement('button');
            chip.type = 'button';
            chip.className = 'active-filter-chip';
            chip.textContent = label;
            if (ariaLabel) {
              chip.setAttribute('aria-label', ariaLabel);
            }
            chip.addEventListener('click', onClick);
            activeFiltersChips.appendChild(chip);
          };

          if (trimmedQuery) {
            appendChip({
              label: `Search: ‚Äú${trimmedQuery}‚Äù`,
              ariaLabel: `Clear search query ${trimmedQuery}`,
              onClick: () => {
                if (search instanceof HTMLInputElement) {
                  search.value = '';
                }
                cachedQuery = '';
                commitState({ replace: false });
                renderCards(applyFilters(''), '');
              },
            });
          }

          tokens.forEach((token) => {
            const label = formatTokenLabel(token);
            appendChip({
              label,
              ariaLabel: `Remove filter ${label}`,
              onClick: () => {
                const [type, value] = token.split(':');
                if (!type || !value) return;
                activeFilters.delete(token);
                const chips = document.querySelectorAll('[data-filter-chip]');
                chips.forEach((chip) => {
                  const chipType = chip.getAttribute('data-filter-type');
                  const chipValue = chip.getAttribute('data-filter-value');
                  if (
                    chipType === type &&
                    chipValue?.toLowerCase() === value.toLowerCase()
                  ) {
                    chip.classList.remove('is-active');
                    chip.setAttribute('aria-pressed', 'false');
                  }
                });
                commitState({ replace: false });
                renderCards(applyFilters(), cachedQuery);
              },
            });
          });

          if (activeFiltersClear instanceof HTMLButtonElement) {
            activeFiltersClear.disabled = !hasTokens;
            activeFiltersClear.setAttribute(
              'aria-disabled',
              String(!hasTokens)
            );
          }
        };

        const updateResultsMeta = (count, _total, query = '') => {
          if (!(searchResults instanceof HTMLElement)) return;
          const hasFilters = query.trim() || activeFilters.size > 0;
          const descriptor = hasFilters ? 'matching stims' : 'total stims';
          const parts = [`${count} ${descriptor}`];
          const trimmedQuery = query.trim();
          if (trimmedQuery) {
            parts.push(`Search: ‚Äú${trimmedQuery}‚Äù`);
          }
          const filterLabels = getActiveFilterLabels();
          if (filterLabels.length > 0) {
            parts.push(`Filters: ${filterLabels.join(', ')}`);
          }
          parts.push(`Sort: ${getSortLabel()}`);
          searchResults.textContent = parts.join(' ‚Ä¢ ');
        };

        const renderEmptyState = () => {
          const empty = document.createElement('div');
          empty.className = 'empty-state';
          const message = document.createElement('p');
          message.className = 'empty-state__message';
          message.textContent =
            'No stims match your search or filters. Try clearing your search or removing filters.';

          const reset = document.createElement('button');
          reset.type = 'button';
          reset.className = 'cta-button ghost';
          reset.textContent = 'Reset search and filters';
          reset.addEventListener('click', () => {
            if (search instanceof HTMLInputElement) {
              search.value = '';
              cachedQuery = '';
            }
            activeFilters.clear();
            sortBy = 'featured';
            const chips = document.querySelectorAll('[data-filter-chip]');
            chips.forEach((chip) => {
              chip.classList.remove('is-active');
              chip.setAttribute('aria-pressed', 'false');
            });
            const sortControl = document.querySelector('[data-sort-control]');
            if (sortControl && sortControl.tagName === 'SELECT') {
              sortControl.value = sortBy;
            }
            commitState({ replace: false });
            renderCards(allToys, '');
          });

          empty.append(message, reset);
          list.appendChild(empty);
        };

        const updateControlVisibility = () => {
          if (clearSearchButton instanceof HTMLElement) {
            const hasQuery = cachedQuery.trim().length > 0;
            clearSearchButton.classList.toggle('is-hidden', !hasQuery);
            clearSearchButton.setAttribute('aria-hidden', String(!hasQuery));
            if (hasQuery) {
              clearSearchButton.removeAttribute('tabindex');
            } else {
              clearSearchButton.setAttribute('tabindex', '-1');
            }
          }
          if (resetFiltersButton instanceof HTMLElement) {
            const hasFilters = activeFilters.size > 0;
            resetFiltersButton.classList.toggle('is-active', hasFilters);
          }
        };

        const getQueryTokens = (query) =>
          (query || '')
            .trim()
            .toLowerCase()
            .split(/[\s,]+/)
            .filter(Boolean);

        const applyFilters = (query = cachedQuery) => {
          const queryTokens = getQueryTokens(query);
          const filtered = allToys.filter((toy) => {
            const haystack = getHaystack(toy);
            const matchesQuery =
              queryTokens.length === 0 ||
              queryTokens.every((token) => haystack.includes(token));
            return matchesQuery && matchesFilters(toy);
          });

          return sortList(filtered);
        };

        const renderCards = (toys = applyFilters(), query = '') => {
          if (shouldDeferToEnhanced()) return;

          list.innerHTML = '';
          updateResultsMeta(toys.length, allToys.length, query || cachedQuery);
          updateActiveFiltersSummary(query || cachedQuery);

          if (toys.length === 0) {
            renderEmptyState();
            return;
          }

          toys.forEach((toy) => {
            const href =
              toy.type === 'page'
                ? toy.module
                : `toy.html?toy=${encodeURIComponent(toy.slug)}`;

            const card = document.createElement('article');
            card.className = 'webtoy-card';
            card.setAttribute('data-toy-fallback', 'true');

            const link = document.createElement('a');
            link.className = 'webtoy-card__link';
            link.href = href;

            const title = document.createElement('h3');
            title.textContent = toy.title;
            const titleId = `toy-title-${toy.slug}`;
            title.id = titleId;

            const desc = document.createElement('p');
            desc.textContent = toy.description;
            const descId = `toy-desc-${toy.slug}`;
            desc.id = descId;

            link.setAttribute('aria-labelledby', titleId);
            link.setAttribute('aria-describedby', descId);

            const content = document.createElement('div');
            content.className = 'webtoy-card__content';
            content.append(title, desc);

            card.append(link, content);

            const badgeRow = document.createElement('div');
            badgeRow.className = 'webtoy-card-meta';

            const badges = [];

            if (toy.requiresWebGPU) {
              badges.push({
                label: 'WebGPU',
                title: 'Requires WebGPU to run.',
              });
            }

            if (toy.capabilities?.microphone) {
              badges.push({
                label: 'Microphone',
                title: 'Uses live microphone input for audio.',
              });
            }

            if (toy.capabilities?.demoAudio) {
              badges.push({
                label: 'Demo audio',
                title: 'Includes a demo track if you skip the mic.',
              });
            }

            if (toy.capabilities?.motion) {
              badges.push({
                label: 'Motion',
                title: 'Responds to device motion or tilt.',
              });
            }

            if (badges.length > 0) {
              badges.forEach((badgeData) => {
                const badge = document.createElement('button');
                const popover = document.createElement('div');
                const popoverId = `capability-${toy.slug}-${badgeData.label
                  .toLowerCase()
                  .replace(/\s+/g, '-')}`;
                badge.className = 'capability-badge';
                badge.type = 'button';
                badge.textContent = badgeData.label;
                badge.setAttribute('aria-controls', popoverId);
                badge.setAttribute('aria-expanded', 'false');
                badge.setAttribute('popovertarget', popoverId);
                badge.setAttribute('popovertargetaction', 'toggle');
                badge.setAttribute('aria-describedby', popoverId);
                popover.className = 'capability-popover';
                popover.id = popoverId;
                popover.setAttribute('popover', 'auto');
                popover.textContent = badgeData.title;
                popover.addEventListener('toggle', (event) => {
                  const isOpen =
                    event?.newState === 'open' ||
                    popover.matches(':popover-open');
                  badge.setAttribute('aria-expanded', String(isOpen));
                });
                badgeRow.appendChild(badge);
                badgeRow.appendChild(popover);
              });

              card.appendChild(badgeRow);
            }

            list.appendChild(card);
          });
        };

        const parseFilters = (value) => {
          if (!value) return [];
          return value
            .split(',')
            .map((token) => token.trim())
            .filter(Boolean);
        };

        const getStateFromUrl = () => {
          const params = new URLSearchParams(window.location.search);
          return {
            query: params.get(QUERY_PARAM) ?? '',
            filters: parseFilters(params.get(FILTER_PARAM)),
            sort: params.get(SORT_PARAM) ?? 'featured',
          };
        };

        const saveStateToStorage = (state) => {
          try {
            window.sessionStorage.setItem(STORAGE_KEY, JSON.stringify(state));
          } catch (error) {
            console.warn('Unable to persist library state', error);
          }
        };

        const readStateFromStorage = () => {
          try {
            const stored = window.sessionStorage.getItem(STORAGE_KEY);
            if (!stored) return null;
            const parsed = JSON.parse(stored);
            if (parsed && typeof parsed === 'object') return parsed;
          } catch (error) {
            console.warn('Unable to restore library state', error);
          }
          return null;
        };

        const stateToParams = (state) => {
          const params = new URLSearchParams(window.location.search);
          if (state.query) {
            params.set(QUERY_PARAM, state.query);
          } else {
            params.delete(QUERY_PARAM);
          }
          if (state.filters?.length) {
            params.set(FILTER_PARAM, state.filters.join(','));
          } else {
            params.delete(FILTER_PARAM);
          }
          if (state.sort && state.sort !== 'featured') {
            params.set(SORT_PARAM, state.sort);
          } else {
            params.delete(SORT_PARAM);
          }
          return params;
        };

        const resolvePathname = () => {
          if (window.location?.pathname) return window.location.pathname;
          if (window.location?.href) {
            try {
              return new URL(window.location.href).pathname;
            } catch (_error) {
              return '/';
            }
          }
          return '/';
        };

        const commitState = ({ replace }) => {
          const state = {
            query: cachedQuery.trim(),
            filters: Array.from(activeFilters),
            sort: sortBy,
          };
          const params = stateToParams(state);
          const nextUrl = `${resolvePathname()}${
            params.toString() ? `?${params.toString()}` : ''
          }`;
          try {
            if (replace) {
              window.history.replaceState(state, '', nextUrl);
            } else {
              window.history.pushState(state, '', nextUrl);
            }
          } catch (_error) {
            // Ignore history errors in non-browser environments.
          }
          saveStateToStorage(state);
        };

        const applyState = (state) => {
          cachedQuery = state.query ?? '';
          sortBy = state.sort ?? 'featured';
          activeFilters.clear();
          (state.filters ?? []).forEach((token) => activeFilters.add(token));
          lastCommittedQuery = cachedQuery.trim();

          if (search instanceof HTMLInputElement) {
            search.value = cachedQuery;
          }

          const chips = document.querySelectorAll('[data-filter-chip]');
          chips.forEach((chip) => {
            const type = chip.getAttribute('data-filter-type');
            const value = chip.getAttribute('data-filter-value');
            if (!type || !value) return;
            const token = `${type}:${value.toLowerCase()}`;
            const isActive = activeFilters.has(token);
            chip.classList.toggle('is-active', isActive);
            chip.setAttribute('aria-pressed', String(isActive));
          });

          const sortControl = document.querySelector('[data-sort-control]');
          if (sortControl && sortControl.tagName === 'SELECT') {
            sortControl.value = sortBy;
          }
          updateControlVisibility();
        };

        const updateSearchSuggestions = (toys) => {
          if (!(searchSuggestions instanceof HTMLDataListElement)) return;
          const suggestions = new Set();
          toys.forEach((toy) => {
            (toy.tags ?? []).forEach((tag) => suggestions.add(tag));
            (toy.moods ?? []).forEach((mood) => suggestions.add(mood));
            Object.entries(toy.capabilities || {})
              .filter(([, enabled]) => !!enabled)
              .forEach(([key]) => suggestions.add(key));
            if (toy.requiresWebGPU) suggestions.add('webgpu');
          });
          searchSuggestions.innerHTML = '';
          [...suggestions]
            .filter((value) => typeof value === 'string' && value.trim())
            .sort((a, b) => a.localeCompare(b))
            .forEach((value) => {
              const option = document.createElement('option');
              option.value = value;
              searchSuggestions.appendChild(option);
            });
        };

        const scheduleRender = (query = cachedQuery, delay = 50) => {
          if (pendingRender) {
            window.clearTimeout(pendingRender);
          }
          pendingRender = window.setTimeout(() => {
            renderCards(applyFilters(query), query);
            updateControlVisibility();
          }, delay);
        };

        fetch('./toys.json')
          .then((response) => (response.ok ? response.json() : null))
          .then((toys) => {
            if (!toys || list.childElementCount > 0) return;

            allToys = toys;
            allToys.forEach((toy, index) => {
              originalOrder.set(toy.slug, index);
            });
            updateSearchSuggestions(allToys);
            const urlState = getStateFromUrl();
            const hasUrlState =
              urlState.query ||
              urlState.filters.length ||
              urlState.sort !== 'featured';
            if (hasUrlState) {
              applyState(urlState);
            } else {
              const storedState = readStateFromStorage();
              if (storedState) {
                applyState(storedState);
                commitState({ replace: true });
              }
            }
            renderCards(applyFilters());
            updateControlVisibility();

            if (searchForm instanceof HTMLFormElement) {
              searchForm.addEventListener('submit', (event) => {
                event.preventDefault();
                if (!(search instanceof HTMLInputElement)) return;
                cachedQuery = search.value.toLowerCase().trim();
                lastCommittedQuery = cachedQuery.trim();
                commitState({ replace: false });
                renderCards(applyFilters(cachedQuery), cachedQuery);
                updateControlVisibility();
              });
            }

            if (search instanceof HTMLInputElement) {
              search.addEventListener('input', () => {
                cachedQuery = search.value.toLowerCase().trim();
                commitState({ replace: true });
                if (searchResults instanceof HTMLElement) {
                  searchResults.textContent = 'Filtering‚Ä¶';
                }
                scheduleRender(cachedQuery);
              });
              search.addEventListener('blur', () => {
                if (cachedQuery.trim() !== lastCommittedQuery) {
                  lastCommittedQuery = cachedQuery.trim();
                  commitState({ replace: false });
                }
              });
            }

            const chips = document.querySelectorAll('[data-filter-chip]');
            chips.forEach((chip) => {
              chip.setAttribute(
                'aria-pressed',
                String(chip.classList.contains('is-active'))
              );
              chip.addEventListener('click', () => {
                const type = chip.getAttribute('data-filter-type');
                const value = chip.getAttribute('data-filter-value');
                if (!type || !value) return;
                const token = `${type}:${value.toLowerCase()}`;
                const isActive = chip.classList.toggle('is-active');
                if (isActive) {
                  activeFilters.add(token);
                } else {
                  activeFilters.delete(token);
                }
                chip.setAttribute('aria-pressed', String(isActive));
                commitState({ replace: false });
                renderCards(applyFilters(), cachedQuery);
                updateControlVisibility();
              });
            });

            const sortControl = document.querySelector('[data-sort-control]');
            if (sortControl && sortControl.tagName === 'SELECT') {
              sortControl.addEventListener('change', () => {
                sortBy = sortControl.value;
                commitState({ replace: false });
                renderCards(applyFilters(), cachedQuery);
              });
            }

            if (
              clearSearchButton instanceof HTMLButtonElement &&
              search instanceof HTMLInputElement
            ) {
              clearSearchButton.addEventListener('click', () => {
                search.value = '';
                cachedQuery = '';
                lastCommittedQuery = '';
                commitState({ replace: false });
                renderCards(applyFilters(''), '');
                updateControlVisibility();
                search.focus();
              });
            }

            if (resetFiltersButton instanceof HTMLButtonElement) {
              resetFiltersButton.addEventListener('click', () => {
                activeFilters.clear();
                const chips = document.querySelectorAll('[data-filter-chip]');
                chips.forEach((chip) => {
                  chip.classList.remove('is-active');
                  chip.setAttribute('aria-pressed', 'false');
                });
                commitState({ replace: false });
                renderCards(applyFilters(), cachedQuery);
                updateControlVisibility();
              });
            }

            if (
              activeFiltersClear instanceof HTMLButtonElement &&
              search instanceof HTMLInputElement
            ) {
              activeFiltersClear.addEventListener('click', () => {
                search.value = '';
                cachedQuery = '';
                activeFilters.clear();
                const chips = document.querySelectorAll('[data-filter-chip]');
                chips.forEach((chip) => {
                  chip.classList.remove('is-active');
                  chip.setAttribute('aria-pressed', 'false');
                });
                commitState({ replace: false });
                renderCards(applyFilters(''), '');
                updateControlVisibility();
              });
            }

            window.addEventListener('popstate', () => {
              const nextState = getStateFromUrl();
              applyState(nextState);
              renderCards(applyFilters(), cachedQuery);
            });
          })
          .catch((error) => {
            console.error('Unable to render library fallback', error);
          });
      });
    </script>
    <script type="module" src="assets/js/hero-canvas.ts"></script>
    <script type="module" src="assets/js/app.ts"></script>
  </body>
</html>
