<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>Interactive Word Cloud & Visualizer</title>
    <script type="module" src="../assets/js/lib/wordcloud2.min.js"></script>
    <link rel="stylesheet" href="../assets/css/base.css" />
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        background: linear-gradient(135deg, #6a11cb, #2575fc);
        background-size: 400% 400%;
        animation: backgroundShift 10s ease infinite;
        position: relative;
      }

      @keyframes backgroundShift {
        0% {
          background-position: 0% 50%;
        }
        50% {
          background-position: 100% 50%;
        }
        100% {
          background-position: 0% 50%;
        }
      }

      #word-cloud-container {
        width: 80vw;
        height: 60vh;
        overflow: hidden;
        border-radius: 15px;
        background: rgba(255, 255, 255, 0.05);
        box-shadow: 0 12px 50px rgba(0, 0, 0, 0.3);
        position: absolute;
        top: 15%;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10;
        mix-blend-mode: screen;
      }

      #word-cloud-canvas {
        width: 100%;
        height: 100%;
      }

      .control-panel {
        position: fixed;
        bottom: 4vh;
        left: 50%;
        transform: translateX(-50%);
        display: grid;
        gap: 8px;
        z-index: 15;
        text-align: center;
      }

      .controls {
        display: flex;
        gap: 20px;
        justify-content: center;
      }

      .manual-panel {
        background: rgba(0, 0, 0, 0.18);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 16px;
        padding: 12px 14px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.35);
        backdrop-filter: blur(12px);
      }

      .manual-banner {
        margin: 0 0 8px;
        padding: 8px 10px;
        border-radius: 12px;
        background: rgba(0, 0, 0, 0.35);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: rgba(255, 255, 255, 0.95);
        font-size: 0.9rem;
      }

      .manual-row {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
      }

      .manual-input {
        min-width: 240px;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.35);
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        font-size: 16px;
        min-height: 44px;
        touch-action: manipulation;
      }

      .manual-input:focus-visible {
        outline: 2px solid rgba(255, 255, 255, 0.9);
        outline-offset: 3px;
        box-shadow: 0 0 0 3px rgba(64, 255, 255, 0.35);
      }

      .pill-button {
        border: 1px solid rgba(255, 255, 255, 0.35);
        border-radius: 999px;
        padding: 10px 14px;
        background: rgba(255, 255, 255, 0.18);
        color: #fff;
        cursor: pointer;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
        min-height: 44px;
        min-width: 44px;
        touch-action: manipulation;
        transition:
          transform 0.2s ease,
          box-shadow 0.2s ease;
      }

      .pill-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.28);
      }

      .pill-button:focus-visible {
        outline: 2px solid rgba(255, 255, 255, 0.95);
        outline-offset: 3px;
        box-shadow: 0 0 0 4px rgba(64, 255, 255, 0.4);
      }

      .pill-button.secondary {
        border-color: rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.12);
      }

      .control-button {
        background: rgba(255, 255, 255, 0.2);
        padding: 20px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        min-height: 44px;
        min-width: 44px;
        touch-action: manipulation;
        transition:
          box-shadow 0.4s ease,
          transform 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        aspect-ratio: 1 / 1;
        overflow: hidden;
        position: relative;
      }

      .control-button:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        box-shadow: none;
      }

      .control-button.active {
        box-shadow: 0 0 60px rgba(255, 255, 255, 0.9);
        background-color: rgba(255, 255, 255, 0.3);
      }

      .control-button:active {
        transform: scale(0.9);
      }

      .control-button:focus-visible {
        outline: 2px solid rgba(255, 255, 255, 0.95);
        outline-offset: 4px;
        box-shadow: 0 0 0 4px rgba(64, 255, 255, 0.45);
      }

      .control-icon {
        width: 35px;
        height: 35px;
        transition: filter 1.5s ease;
        filter: drop-shadow(0 0 15px rgba(255, 255, 255, 0.7));
      }

      .control-hint {
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.95rem;
        text-shadow: 0 1px 6px rgba(0, 0, 0, 0.35);
        max-width: 520px;
        margin: 0 auto;
        line-height: 1.3;
      }

      .particle {
        position: absolute;
        border-radius: 50%;
        pointer-events: none;
        animation: particleFloat 4s ease-in-out infinite alternate;
        opacity: 0.8;
        z-index: 5;
        mix-blend-mode: difference;
      }

      @keyframes particleFloat {
        0% {
          transform: translateY(0) translateX(0) scale(1);
          opacity: 0.5;
        }
        50% {
          transform: translateY(-20px) translateX(20px) scale(1.3);
          opacity: 1;
        }
        100% {
          transform: translateY(-40px) translateX(-20px) scale(1);
          opacity: 0.5;
        }
      }
    </style>
  </head>
  <body>
    <a href="../index.html" class="home-link">Back to Library</a>
    <div class="control-panel">
      <div class="controls">
        <button
          id="unmute-button"
          class="control-button"
          aria-label="Unmute Visualizer"
          title="Toggle Visualizer"
        >
          <img
            id="unmute-icon"
            class="control-icon"
            src="./assets/ui/mic-off.svg"
            alt="Mic Access Icon"
            width="35"
            height="35"
            loading="lazy"
            decoding="async"
          />
        </button>

        <button
          id="toggle-speech-button"
          class="control-button"
          aria-label="Speech Recognition"
          title="Toggle Speech Recognition"
        >
          <img
            id="toggle-speech-icon"
            class="control-icon"
            src="./assets/ui/speech-off.svg"
            alt="Add Word Icon"
            width="35"
            height="35"
            loading="lazy"
            decoding="async"
          />
        </button>
      </div>
      <p class="control-hint" id="status-message">
        Unmute to sync the visuals with your microphone. Speech controls appear
        when your browser supports them.
      </p>
      <div class="manual-panel" id="manual-panel">
        <p class="manual-banner" id="manual-banner">
          No mic? Type a few words below or hit “Add sample words” (or press
          Space) to demo the word cloud animation.
        </p>
        <div class="manual-row">
          <label class="visually-hidden" for="manual-words"
            >Add words manually</label
          >
          <input
            id="manual-words"
            class="manual-input"
            name="manual-words"
            type="text"
            autocomplete="off"
            placeholder="Type words, separate with commas or spaces"
          />
          <button id="add-words-button" class="pill-button" type="button">
            Add words
          </button>
          <button
            id="demo-words-button"
            class="pill-button secondary"
            type="button"
          >
            Add sample words
          </button>
        </div>
        <p class="control-hint" style="margin-top: 8px; margin-bottom: 0">
          Press Enter to submit. Use “Add sample words” or press Space to pulse
          the cloud for a no-mic demo.
        </p>
      </div>
    </div>

    <div id="word-cloud-container">
      <canvas id="word-cloud-canvas" class="toy-canvas"></canvas>
      <div id="error-message" style="display: none"></div>
    </div>

    <script type="module">
      import {
        getFrequencyData,
        initAudio,
      } from '../assets/js/utils/audio-handler.ts';
      import { showError } from '../assets/js/utils/error-display.ts';
      import { startToyAudio } from '../assets/js/utils/start-audio.ts';

      const wordCloudCanvas = document.getElementById('word-cloud-canvas');
      const unmuteButton = document.getElementById('unmute-button');
      const toggleSpeechButton = document.getElementById(
        'toggle-speech-button'
      );
      const unmuteIcon = document.getElementById('unmute-icon');
      const toggleSpeechIcon = document.getElementById('toggle-speech-icon');
      const manualPanel = document.getElementById('manual-panel');
      const manualBanner = document.getElementById('manual-banner');
      const manualInput = document.getElementById('manual-words');
      const addWordsButton = document.getElementById('add-words-button');
      const demoWordsButton = document.getElementById('demo-words-button');
      const statusMessage = document.getElementById('status-message');
      const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;
      const speechSupported = Boolean(SpeechRecognition);
      let recognition = null;
      const STORAGE_KEY = 'stim-words-state';

      const seedWords = [
        'pulse',
        'color',
        'flow',
        'echo',
        'harmony',
        'spark',
        'glow',
        'breathe',
        'calm',
        'wave',
        'rhythm',
      ];

      const demoWordSets = [
        ['vibe', 'cosmos', 'pixel', 'wisp', 'lumen', 'glide'],
        ['glitter', 'orbital', 'sonic', 'river', 'spark'],
        ['neon', 'drift', 'hush', 'glow', 'warp', 'pulse'],
      ];

      function setStatus(text) {
        if (statusMessage) {
          statusMessage.textContent = text;
        }
      }

      function addWordsToCloud(words) {
        if (!Array.isArray(words) || !words.length) return;

        wordsArray = wordsArray.concat(words);

        if (wordsArray.length > 1000) {
          wordsArray = wordsArray.slice(wordsArray.length - 1000);
        }

        updateWordCloud(wordsArray);
        saveStoredState();
      }

      function normalizeInputWords(text) {
        return text
          .split(/[,\n]+|\s{2,}/)
          .flatMap((chunk) => chunk.trim().split(/\s+/))
          .map((word) => word.trim())
          .filter(Boolean);
      }

      class AudioToy {
        constructor() {
          this.analyser = null;
          this.audioCleanup = null;
          this.loopId = null;
          this.renderLoop = null;
          this.renderer = {
            setAnimationLoop: (loop) => {
              if (this.loopId) {
                cancelAnimationFrame(this.loopId);
              }

              this.renderLoop = loop;

              if (!loop) return;

              const tick = () => {
                this.renderLoop?.();
                this.loopId = requestAnimationFrame(tick);
              };

              tick();
            },
          };
        }

        async initAudio(options = {}) {
          const audio = await initAudio(options);
          this.analyser = audio.analyser;
          this.audioCleanup = audio.cleanup;
          return audio;
        }

        dispose() {
          if (this.loopId) {
            cancelAnimationFrame(this.loopId);
          }

          this.renderLoop = null;
          this.loopId = null;
          this.audioCleanup?.();
          this.analyser = null;
        }
      }

      let toy = null;

      let isUnmuted = false;
      let isAddingWords = false;
      let wordsArray = [...seedWords];
      let wordCloudData = [];

      // Word cloud shapes for randomness
      const shapes = ['circle', 'star', 'triangle', 'diamond'];

      const speechUnavailableMessage =
        'Speech recognition is unavailable. Use the manual input below or add sample words to keep the cloud active.';

      function loadStoredState() {
        if (!('sessionStorage' in window)) return null;

        try {
          const stored = window.sessionStorage.getItem(STORAGE_KEY);
          if (!stored) return null;
          const parsed = JSON.parse(stored);
          if (!parsed || typeof parsed !== 'object') return null;
          if (Array.isArray(parsed.words) && parsed.words.length) {
            return {
              words: parsed.words.filter((word) => typeof word === 'string'),
              manualText:
                typeof parsed.manualText === 'string' ? parsed.manualText : '',
            };
          }
        } catch (error) {
          console.warn('Unable to load stored word cloud state:', error);
        }

        return null;
      }

      function saveStoredState() {
        if (!('sessionStorage' in window)) return;

        try {
          window.sessionStorage.setItem(
            STORAGE_KEY,
            JSON.stringify({
              words: wordsArray,
              manualText: manualInput?.value ?? '',
            })
          );
        } catch (error) {
          console.warn('Unable to save word cloud state:', error);
        }
      }

      function focusManualInput() {
        if (!manualInput || !manualPanel) return;
        manualPanel.scrollIntoView({ behavior: 'smooth', block: 'center' });
        window.setTimeout(() => manualInput.focus(), 120);
      }

      function updateUnmuteIcon() {
        unmuteIcon.src = isUnmuted
          ? './assets/ui/mic-on.svg'
          : './assets/ui/mic-off.svg';
      }

      function updateSpeechIcon() {
        if (!toggleSpeechIcon) return;

        toggleSpeechIcon.src = isAddingWords
          ? './assets/ui/speech-on.svg'
          : './assets/ui/speech-off.svg';
      }

      function disableSpeechToggle(message) {
        isAddingWords = false;

        if (toggleSpeechButton) {
          toggleSpeechButton.classList.remove('active');
          toggleSpeechButton.disabled = true;
          toggleSpeechButton.title = message;
        }

        updateSpeechIcon();
        setStatus(message);
      }

      function initSpeechRecognition() {
        if (!speechSupported) {
          disableSpeechToggle(speechUnavailableMessage);
          toggleSpeechButton?.remove();
          updateSpeechIcon();
          manualBanner.textContent =
            'Speech isn’t supported here. Add words manually or tap “Add sample words” to animate the cloud.';
          focusManualInput();
          return;
        }

        recognition = new SpeechRecognition();
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
      }

      function updateWordCloud(words) {
        if (WordCloud.isSupported) {
          const wordFrequency = words.reduce((freq, word) => {
            freq[word] = (freq[word] || 0) + 1;
            return freq;
          }, {});

          wordCloudData = Object.entries(wordFrequency).map(([word, count]) => [
            word,
            count,
          ]);

          const randomShape = shapes[Math.floor(Math.random() * shapes.length)];

          WordCloud(wordCloudCanvas, {
            list: wordCloudData,
            gridSize: Math.floor(10 * (window.innerWidth / 1024)),
            weightFactor: 15,
            color: () => `hsl(${Math.random() * 360}, 100%, 50%)`,
            rotateRatio: 0.4,
            minRotation: -Math.PI / 6,
            maxRotation: Math.PI / 6,
            backgroundColor: 'transparent',
            shape: randomShape,
            drawOutOfBound: false,
            shrinkToFit: true,
            clearCanvas: true,
          });
        }
      }

      function handleManualWordSubmit() {
        const manualText = manualInput?.value ?? '';
        const words = normalizeInputWords(manualText);

        if (!words.length) return;

        addWordsToCloud(words);

        if (manualInput) {
          manualInput.value = '';
        }

        saveStoredState();
      }

      function addDemoWords() {
        const sample =
          demoWordSets[Math.floor(Math.random() * demoWordSets.length)];
        addWordsToCloud(sample);
        updateWordCloudWithVisualizer(90);
        createParticleEffects(90);
      }

      // Unmute button logic for music visualizer activation
      unmuteButton.addEventListener('click', () => {
        if (!isUnmuted) {
          isUnmuted = true;
          unmuteButton.classList.add('active');
          updateUnmuteIcon();
          deactivateSpeechRecognition(); // Ensure speech recognition is turned off before starting visualizer
          activateVisualizer();
        } else {
          isUnmuted = false;
          unmuteButton.classList.remove('active');
          updateUnmuteIcon();
          deactivateVisualizer();
        }
      });

      addWordsButton?.addEventListener('click', handleManualWordSubmit);
      demoWordsButton?.addEventListener('click', addDemoWords);

      manualInput?.addEventListener('input', () => {
        saveStoredState();
      });

      manualInput?.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          handleManualWordSubmit();
        }
      });

      window.addEventListener('keydown', (event) => {
        const target = event.target;
        const isTypingTarget =
          target instanceof HTMLInputElement ||
          target instanceof HTMLTextAreaElement;

        if (event.code === 'Space' && !isTypingTarget) {
          event.preventDefault();
          addDemoWords();
        }
      });

      async function activateVisualizer() {
        try {
          toy = toy ?? new AudioToy();
          await startToyAudio(toy, animate, { fallbackToSynthetic: true });
        } catch (error) {
          console.error('Error accessing microphone for visualizer:', error);
          showError(
            'error-message',
            'Microphone access is required for the visualization to work. Please allow microphone access.'
          );
          isUnmuted = false;
          unmuteButton.classList.remove('active');
          updateUnmuteIcon();
          deactivateVisualizer();
        }
      }

      function animate(ctxAudio) {
        if (!isUnmuted) return;

        const dataArray = ctxAudio.analyser
          ? getFrequencyData(ctxAudio.analyser)
          : new Uint8Array(0);
        const maxVolume = dataArray.length ? Math.max(...dataArray) : 0;

        updateWordCloudWithVisualizer(maxVolume);
        createParticleEffects(maxVolume);
      }

      function deactivateVisualizer() {
        toy?.dispose();
        toy = null;
        document.querySelectorAll('.particle').forEach((p) => p.remove());
      }

      function updateWordCloudWithVisualizer(volume) {
        if (WordCloud.isSupported && wordCloudData.length) {
          WordCloud(wordCloudCanvas, {
            list: wordCloudData.map(([word, count]) => [
              word,
              count * (1 + volume / 256),
            ]),
            gridSize: Math.floor(10 * (window.innerWidth / 1024)),
            weightFactor: 15,
            color: () =>
              `hsl(${Math.random() * 360}, 100%, ${50 + volume / 10}%)`,
            rotateRatio: 0.4,
            minRotation: -Math.PI / 6,
            maxRotation: Math.PI / 6,
            backgroundColor: 'transparent',
            shape: 'circle',
            drawOutOfBound: false,
            shrinkToFit: true,
            clearCanvas: true,
          });
        }
      }

      function createParticleEffects(volume) {
        document.querySelectorAll('.particle').forEach((p) => p.remove());
        const particleCount = Math.min(volume / 10, 10);

        for (let i = 0; i < particleCount; i++) {
          const particle = document.createElement('div');
          particle.className = 'particle';
          particle.style.width = `${Math.random() * 8 + 3}px`;
          particle.style.height = particle.style.width;
          particle.style.left = `${Math.random() * 90}vw`;
          particle.style.top = `${Math.random() * 80}vh`;
          particle.style.background = `hsl(${Math.random() * 360}, 100%, 75%)`;
          document.body.appendChild(particle);
        }
      }

      // Toggle speech button logic for speech detection
      toggleSpeechButton?.addEventListener('click', () => {
        if (!recognition) {
          disableSpeechToggle(speechUnavailableMessage);
          return;
        }

        if (!isAddingWords) {
          isAddingWords = true;
          toggleSpeechButton.classList.add('active');
          updateSpeechIcon();
          deactivateVisualizer(); // Ensure visualizer is turned off before starting speech recognition
          setStatus('Listening for words…');
          try {
            recognition.start();
          } catch (error) {
            console.error('Unable to start speech recognition:', error);
            disableSpeechToggle(
              'Speech recognition could not start. Please check your permissions and try again.'
            );
          }
        } else {
          isAddingWords = false;
          toggleSpeechButton.classList.remove('active');
          updateSpeechIcon();
          recognition.stop();
          setStatus(
            'Speech paused. Keep typing or add sample words to grow the cloud.'
          );
        }
      });

      function deactivateSpeechRecognition() {
        if (isAddingWords && recognition) {
          isAddingWords = false;
          toggleSpeechButton.classList.remove('active');
          updateSpeechIcon();
          recognition.stop();
        }
      }

      initSpeechRecognition();

      const storedState = loadStoredState();
      if (storedState?.words?.length) {
        wordsArray = storedState.words;
      }

      if (manualInput && storedState?.manualText) {
        manualInput.value = storedState.manualText;
      }

      if (speechSupported) {
        setStatus(
          'Unmute to sync with your mic. Enable speech to sprinkle your words into the cloud.'
        );
      } else {
        setStatus(
          'Speech recognition is unavailable. Type words, press Enter, or add sample words to keep the cloud moving.'
        );
      }

      if (recognition) {
        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          const newWords = transcript.split(' ');
          addWordsToCloud(newWords);
        };

        recognition.onspeechend = () => {
          if (isAddingWords) {
            recognition.start(); // Keep listening as long as the toggle is active
          } else {
            recognition.stop();
          }
        };

        recognition.onerror = (event) => {
          console.error('Speech recognition error:', event.error);

          if (
            event.error === 'not-allowed' ||
            event.error === 'service-not-allowed'
          ) {
            disableSpeechToggle(
              'Speech recognition permission was denied. You can keep using the default word cloud.'
            );
            setStatus(
              'Speech recognition permission was denied. Type words or use sample words instead.'
            );
            manualBanner.textContent =
              'Mic access is blocked. Keep typing below or use “Add sample words” to animate without speech.';
            focusManualInput();
            return;
          }

          setStatus(
            'Speech recognition hiccuped. Keep typing or try toggling speech again.'
          );

          if (isAddingWords) {
            recognition.start();
          }
        };
      }

      // Initial word cloud rendering for visibility testing
      updateUnmuteIcon();
      updateSpeechIcon();
      updateWordCloud(wordsArray);
      saveStoredState();
    </script>
  </body>
</html>
